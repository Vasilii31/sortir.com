{% extends 'base.html.twig' %}

{% block title %}New Sortie{% endblock %}

{% block body %}
    <h4 class="txt-custom-prim my-3">Créer une nouvelle sortie</h4>
    <div class="card my-3 p-3">
        {{ form_start(form) }}

        {{ form_row(form.nom) }}
        {{ form_row(form.datedebut) }}
        {{ form_row(form.datecloture) }}
        {{ form_row(form.nbInscriptionsMax) }}
        {{ form_row(form.duree) }}
        {{ form_row(form.descriptionInfos) }}
        {{ form_row(form.ville) }}
        {{ form_row(form.lieu) }}


        <div id="lieu-details" class="mt-3" style="display: none;">
            <p><strong>Rue :</strong> <span id="rue-display"></span></p>
            <p><strong>Code postal :</strong> <span id="ville-cp"></span></p>
            <p><strong>Latitude :</strong> <span id="latitude"></span></p>
            <p><strong>Longitude :</strong> <span id="longitude"></span></p>
        </div>
        <button class="a-custom-sec">Enregistrer</button>
        <button class="a-custom-prim">Publier</button>
        <button class="a-custom-warn">Annuler</button>
        {{ form_end(form) }}

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const selectVille = document.getElementById('{{ form.ville.vars.id }}');
                const selectLieu  = document.getElementById('{{ form.lieu.vars.id }}');
                const spanRue     = document.getElementById('rue-display');
                const spanCp      = document.getElementById('ville-cp');
                const spanLatitude = document.getElementById('latitude');
                const spanLongitude = document.getElementById('longitude');
                const divDetails  = document.getElementById('lieu-details');

                const allOptions = Array.from(selectLieu.options);

                // Désactiver le select Lieu au départ si aucune ville sélectionnée
                selectLieu.disabled = !selectVille.value;

                function updateLieuOptions() {
                    const villeId = selectVille.value;

                    selectLieu.innerHTML = '';
                    selectLieu.appendChild(new Option('Choisissez un lieu', ''));

                    if (!villeId) {
                        selectLieu.disabled = true; // désactivé si pas de ville
                        updateLieuDetails();
                        return;
                    }

                    selectLieu.disabled = false; // activer le select
                    allOptions.forEach(opt => {
                        if (opt.dataset.villeId === villeId) {
                            selectLieu.appendChild(opt);
                        }
                    });

                    updateLieuDetails();
                }

                function updateLieuDetails() {
                    const opt = selectLieu.options[selectLieu.selectedIndex];
                    if (!opt) return;

                    spanRue.textContent   = opt.dataset.rue || '';
                    spanCp.textContent    = opt.dataset.cp || '';
                    spanLatitude.textContent = opt.dataset.latitude || '';
                    spanLongitude.textContent = opt.dataset.longitude || '';
                    divDetails.style.display = spanRue.textContent ? 'block' : 'none';
                }

                selectVille.addEventListener('change', updateLieuOptions);
                selectLieu.addEventListener('change', updateLieuDetails);

                // initialisation
                updateLieuOptions();
            });



        </script>

        {% endblock %}



