{% extends 'base.html.twig' %}

{% block title %}New Sortie{% endblock %}

{% block body %}

    <h4 class="txt-custom-prim my-3">Cr√©er une nouvelle sortie</h4>

    <div class="card my-3 p-4 shadow-sm">
        {{ form_start(form) }}

        {% include 'sortie/_form_fields.html.twig' %}

        <div class="d-flex justify-content-center gap-3 mt-4">
            {{ form_widget(form.enregistrer, {'attr': {'class': 'a-custom-sec'}}) }}
            {{ form_widget(form.publier, {'attr': {'class': 'a-custom-sec'}}) }}
            <a href="{{ path('app_sortie_index') }}" class="a-custom-warn">Annuler</a>
        </div>

        {{ form_end(form) }}
    </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const selectVille = document.getElementById('{{ form.ville.vars.id }}');
                const selectLieu  = document.getElementById('{{ form.lieu.vars.id }}');

                const spanRue      = document.getElementById('rue-display');
                const spanCp       = document.getElementById('ville-cp');
                const spanLatitude = document.getElementById('latitude');
                const spanLongitude= document.getElementById('longitude');
                const divDetails   = document.getElementById('lieu-details');

                const options = Array.from(selectLieu.querySelectorAll("option"))
                    .filter(opt => opt.value !== "");

                function resetLieu() {
                    selectLieu.innerHTML = '';
                    const placeholder = new Option('Choisissez un lieu', '', true, true);
                    placeholder.disabled = true;
                    selectLieu.appendChild(placeholder);
                    selectLieu.disabled = true;
                    updateLieuDetails();
                }

                function updateLieuOptions() {
                    const villeId = selectVille.value;
                    if (!villeId) {
                        resetLieu();
                        return;
                    }

                    selectLieu.disabled = false;
                    selectLieu.innerHTML = '';
                    const placeholder = new Option('Choisissez un lieu', '', true, true);
                    placeholder.disabled = true;
                    selectLieu.appendChild(placeholder);

                    options.forEach(opt => {
                        if (opt.dataset.villeId === villeId) {
                            selectLieu.appendChild(opt.cloneNode(true));
                        }
                    });

                    selectLieu.value = '';
                    updateLieuDetails();
                }

                function updateLieuDetails() {
                    const opt = selectLieu.options[selectLieu.selectedIndex];
                    if (!opt || !opt.value) {
                        spanRue.textContent = '';
                        spanCp.textContent = '';
                        spanLatitude.textContent = '';
                        spanLongitude.textContent = '';
                        divDetails.style.display = 'none';
                        return;
                    }
                    spanRue.textContent      = opt.dataset.rue || '';
                    spanCp.textContent       = opt.dataset.cp || '';
                    spanLatitude.textContent = opt.dataset.latitude || '';
                    spanLongitude.textContent= opt.dataset.longitude || '';
                    divDetails.style.display = 'block';
                }

                selectVille.addEventListener('change', updateLieuOptions);
                selectLieu.addEventListener('change', updateLieuDetails);

                updateLieuOptions();
            });

        </script>


{% endblock %}



